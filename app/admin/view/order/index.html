<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>订单管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
</head>
<body style="padding: 20px; background-color: #fff;">
    <div class="layui-card">
        <div class="layui-card-header">订单管理</div>
        <div class="layui-card-body">
            <div class="layui-form layui-form-pane" style="margin-bottom: 10px;">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">订单号</label>
                        <div class="layui-input-inline">
                            <input type="text" id="search-no" placeholder="订单号搜索" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button class="layui-btn layui-btn-primary" onclick="search()"><i class="layui-icon layui-icon-search"></i> 搜索</button>
                    </div>
                </div>
            </div>
            <table id="orderTable" lay-filter="orderTable"></table>
        </div>
    </div>

    <script type="text/html" id="statusTpl">
        {{# if(d.status == 1){ }}
        <span class="layui-badge layui-bg-green">已支付</span>
        {{# } else if(d.status == 0 && d.is_expired){ }}
        <span class="layui-badge" style="background-color: red !important; color: white !important;">已超时</span>
        {{# } else if(d.status == 0 && d.expire_seconds > 0){ }}
        <span class="layui-badge layui-bg-orange">未支付</span>
        <div class="order-countdown" data-seconds="{{d.expire_seconds}}" data-id="{{d.id}}" style="font-size:12px; color:#e6a23c; margin-top:3px;"></div>
        {{# } else { }}
        <span class="layui-badge layui-bg-orange">未支付</span>
        {{# } }}
    </script>

    <script type="text/html" id="bar">
        {{# if(d.status == 0 && !d.is_expired){ }}
        <a class="layui-btn layui-btn-xs" lay-event="confirm">确认支付</a>
        {{# } }}
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>

    <script type="text/html" id="payTypeTpl">
        {{# if(d.pay_type == 'alipay'){ }}
            <span style="color: #1677ff;">支付宝</span>
        {{# } else if(d.pay_type == 'wxpay' || d.pay_type == 'wechat'){ }}
            <span style="color: #09b908;">微信支付</span>
        {{# } else if(d.pay_type == 'qqpay'){ }}
            <span style="color: #12b7f5;">QQ钱包</span>
        {{# } else if(d.pay_type == 'balance'){ }}
            <span style="color: #ff8c00;">余额支付</span>
        {{# } else if(d.pay_type == 'manual'){ }}
            <span class="layui-badge layui-bg-gray">后台手动</span>
        {{# } else if(d.pay_type){ }}
            <span>{{d.pay_type}}</span>
        {{# } else { }}
            <span>-</span>
        {{# } }}
    </script>

    <script src="/static/layui/layui.js"></script>
    <script>
        var table, layer;
        layui.use(['table', 'layer'], function(){
            table = layui.table;
            layer = layui.layer;
            var $ = layui.$;

            table.render({
                elem: '#orderTable',
                url: "{:url('order/index')}",
                page: true,
                cols: [[
                    {field: 'order_no', title: '订单号', width: 200},
                    {field: 'user', title: '用户', templet: function(d){ return d.user ? d.user.username : '游客'; }},
                    {field: 'type', title: '类型', width: 120, templet: function(d){ 
                        if(d.type == 1) return '<span class="layui-badge layui-bg-blue">资源</span>';
                        if(d.type == 3) {
                            var vipName = d.vip_level ? d.vip_level.name : 'VIP';
                            return '<span class="layui-badge layui-bg-bk">' + vipName + '</span>';
                        }
                        return '未知';
                    }},
                    {field: 'article', title: '资源/文章', templet: function(d){ return d.article ? d.article.title : '-'; }},
                    {field: 'price', title: '金额', width: 100},
                    {field: 'status', title: '状态', templet: '#statusTpl', width: 100},
                    {field: 'pay_type', title: '支付方式', width: 100, templet: '#payTypeTpl'},
                    {field: 'create_time', title: '时间', width: 160},
                    {fixed: 'right', title: '操作', toolbar: '#bar', width: 160}
                ]]
            });

            table.on('tool(orderTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'confirm'){
                    layer.confirm('确认手动变更订单为已支付状态吗？', function(index){
                        $.post("{:url('order/confirmPay')}", {order_no: data.order_no}, function(res){
                            if(res.code === 1){
                                table.reload('orderTable');
                                layer.close(index);
                                layer.msg(res.msg, {icon: 1});
                            }else{
                                layer.msg(res.msg, {icon: 2});
                            }
                        }, 'json');
                    });
                } else if(obj.event === 'del'){
                    layer.confirm('真的删除行么', function(index){
                        $.post("{:url('order/delete')}", {id: data.id}, function(res){
                            if(res.code === 1){
                                obj.del();
                                layer.close(index);
                                layer.msg(res.msg, {icon: 1});
                            }else{
                                layer.msg(res.msg, {icon: 2});
                            }
                        }, 'json');
                    });
                }
            });
        });

        function search() {
            var order_no = layui.$('#search-no').val();
            table.reload('orderTable', {
                where: {order_no: order_no},
                page: {curr: 1}
            });
        }

        // Countdown timer for pending orders
        function startCountdowns() {
            var $items = $('.order-countdown');
            $items.each(function(){
                var $el = $(this);
                var secs = parseInt($el.data('seconds'));
                if(isNaN(secs) || secs <= 0) {
                    $el.text('已超时');
                    return;
                }
                $el.data('_secs', secs);
                updateCountdownText($el, secs);
            });
        }
        function updateCountdownText($el, secs) {
            var m = Math.floor(secs / 60);
            var s = secs % 60;
            $el.text((m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s));
        }
        setInterval(function(){
            var $items = $('.order-countdown');
            $items.each(function(){
                var $el = $(this);
                var secs = $el.data('_secs');
                if(typeof secs === 'undefined' || secs <= 0) return;
                secs--;
                $el.data('_secs', secs);
                if(secs <= 0) {
                    $el.text('已超时');
                    $el.css('color', 'red');
                    // Auto close: change status badge
                    $el.prev('.layui-badge').text('已超时').css({'background-color':'red','color':'#fff'});
                    // Reload table after a short delay
                    setTimeout(function(){ table.reload('orderTable'); }, 1500);
                } else {
                    updateCountdownText($el, secs);
                }
            });
        }, 1000);

        // Start countdowns after table renders
        $(document).on('DOMNodeInserted', '#orderTable + .layui-table-view', function(){ setTimeout(startCountdowns, 300); });
        // Also start on page load (for initial render)
        setTimeout(startCountdowns, 500);
    </script>
</body>
</html>
