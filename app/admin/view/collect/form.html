<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>节点配置</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
</head>
<body>
    <div style="padding: 20px;">
        <form class="layui-form" action="">
            <input type="hidden" name="id" value="{$info.id|default='0'}">
            
            <div class="layui-form-item">
                <label class="layui-form-label">节点名称</label>
                <div class="layui-input-block">
                    <input type="text" name="name" value="{$info.name|default=''}" lay-verify="required" placeholder="如：某博客列表" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">入库分类</label>
                <div class="layui-input-block">
                    <select name="category_id" lay-verify="required">
                        <option value="">请选择保存到哪个分类</option>
                        {volist name="categories" id="vo"}
                        <option value="{$vo.id}" {if condition="$info && $info.category_id == $vo.id"}selected{/if}>{$vo.name}</option>
                        {/volist}
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">采集地址</label>
                <div class="layui-input-block">
                    <input type="text" name="url" value="{$info.url|default=''}" lay-verify="required" placeholder="示例：http://demo.com/list/page/[page].html" class="layui-input">
                    <div class="layui-form-mid layui-word-aux">分页符使用全小写 [page] 代替数字。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">页面编码</label>
                <div class="layui-input-block">
                    <input type="radio" name="charset" value="utf-8" title="UTF-8" {if condition="!$info || $info.charset == 'utf-8'"}checked{/if}>
                    <input type="radio" name="charset" value="gbk" title="GBK/GB2312" {if condition="$info && $info.charset == 'gbk'"}checked{/if}>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">列表A标签</label>
                <div class="layui-input-block">
                    <input type="text" name="list_selector" value="{$info.list_selector|default=''}" lay-verify="required" placeholder="如：.post-list a.title" class="layui-input">
                    <div class="layui-form-mid layui-word-aux">提取列表页中指向文章详情的 a 标签选择器。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">标题选择器</label>
                <div class="layui-input-block">
                    <input type="text" name="title_selector" value="{$info.title_selector|default=''}" lay-verify="required" placeholder="如：.article h1" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">内容选择器</label>
                <div class="layui-input-block">
                    <input type="text" name="content_selector" value="{$info.content_selector|default=''}" lay-verify="required" placeholder="如：.article-content" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">下载选择器</label>
                <div class="layui-input-block">
                    <input type="text" name="download_selector" value="{$info.download_selector|default=''}" placeholder="如：.xiazai-btn a" class="layui-input">
                    <div class="layui-form-mid layui-word-aux">提取下载链接的 a 标签选择器。留空则启用全量智能识别。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">出售价格</label>
                <div class="layui-input-block">
                    <input type="number" step="0.01" name="price" value="{$info.price|default='0.00'}" placeholder="0.00" class="layui-input" style="width: 120px;">
                    <div class="layui-form-mid layui-word-aux">采集过来的内容入库时设置的默认出售金币价格（0为免费）。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">下载图片</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="image_download" lay-skin="switch" lay-text="开启|关闭" value="1" {if condition="!$info || $info.image_download == 1"}checked{/if}>
                    <div class="layui-form-mid layui-word-aux">开启后自动下载内容中的图片到本地服务器并替换链接。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">屏蔽词</label>
                <div class="layui-input-block">
                    <textarea name="filter_words" placeholder="每行一个屏蔽词，采集时会移除包含这些文字的HTML元素&#10;示例：&#10;查看演示&#10;立即下载&#10;在线预览" class="layui-textarea" style="height: 120px;">{$info.filter_words|default=''}</textarea>
                    <div class="layui-form-mid layui-word-aux">采集内容中包含这些关键词的元素将被整体移除（如按钮、链接等）。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">请求间隔(秒)</label>
                <div class="layui-input-block">
                    <input type="number" name="request_delay" value="{$info.request_delay|default='2'}" placeholder="2" min="1" max="30" class="layui-input" style="width: 120px;">
                    <div class="layui-form-mid layui-word-aux">每次请求之间的等待时间（秒），防止被目标站判定为攻击行为。建议 2~5 秒。</div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="save">保存节点</button>
                    <button type="button" class="layui-btn layui-btn-warm" id="testDetailBtn">测试单页提取</button>
                    <div class="layui-form-mid layui-word-aux">先保存再测试。</div>
                </div>
            </div>
        </form>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['form', 'layer', 'jquery'], function(){
            var form = layui.form;
            var layer = layui.layer;
            var $ = layui.jquery;

            // 监听提交
            form.on('submit(save)', function(data){
                // fix switch state
                if(data.field.image_download === undefined){
                    data.field.image_download = 0;
                }
                
                $.post('{:url("collect/save")}', data.field, function(res){
                    if(res.code === 1){
                        layer.msg(res.msg, {icon: 1, time: 1000}, function(){
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                    }else{
                        layer.msg(res.msg, {icon: 2});
                    }
                }, 'json');
                return false;
            });

            // 测试详情页
            $('#testDetailBtn').click(function(){
                var id = $('input[name="id"]').val();
                if(id == 0){
                    layer.msg('请先保存节点配置后再测试', {icon: 0});
                    return;
                }
                layer.prompt({
                    title: '输入测试的文章详情页URL',
                    value: ''
                }, function(value, index){
                    layer.close(index);
                    var loadIndex = layer.load();
                    $.post('{:url("collect/test")}', {id: id, url: value}, function(res){
                        layer.close(loadIndex);
                        if(res.code == 1){
                            layer.open({
                                type: 1,
                                title: '提取结果 [ ' + res.data.title + ' ]',
                                area: ['800px', '600px'],
                                content: '<div style="padding: 20px;">' + res.data.content + '</div>'
                            });
                        }else{
                            layer.alert(res.msg, {title: '失败', icon: 2});
                        }
                    }, 'json');
                });
            });
        });
    </script>
</body>
</html>
