<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é‡‡é›†èŠ‚ç‚¹ç®¡ç†</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        .container { padding: 20px; }
        .layui-card-header { font-weight: bold; }
        td .layui-btn { margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="container layui-form">
        <div class="layui-card">
            <div class="layui-card-header">
                é‡‡é›†èŠ‚ç‚¹ç®¡ç†
                <button class="layui-btn layui-btn-sm layui-btn-normal" style="float:right;margin-top:5px;" id="addNode">æ·»åŠ èŠ‚ç‚¹</button>
                <button class="layui-btn layui-btn-sm layui-btn-warm" style="float:right;margin-top:5px;margin-right:10px;" onclick="location.href='{:url(\"collect/draft\")}'"><i class="layui-icon layui-icon-file-b"></i> è‰ç¨¿ç®¡ç†</button>
            </div>
            <div class="layui-card-body">
                <table class="layui-hide" id="nodeTable" lay-filter="nodeTable"></table>
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼æ“ä½œåˆ— -->
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">ç¼–è¾‘</a>
        <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="test">æµ‹è¯•é‡‡é›†</a>
        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="execute">æ‰§è¡Œé‡‡é›†</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</a>
    </script>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['table', 'jquery', 'layer'], function(){
            var table = layui.table;
            var $ = layui.jquery;
            var layer = layui.layer;

            // ===== é‡‡é›†è¿›åº¦å…¨å±€çŠ¶æ€ =====
            window._collectSSE = null;       // EventSource å®ä¾‹
            window._collectLogs = [];        // æ—¥å¿—ç¼“å­˜
            window._collectStats = {success:0, fail:0, skip:0}; // ç»Ÿè®¡
            window._collectTitle = '';       // é‡‡é›†æ ‡é¢˜
            window._collectDone = false;     // æ˜¯å¦å®Œæˆ
            window._collectPanelIndex = null; // å¼¹çª—layerç´¢å¼•

            // åˆ›å»º/æ˜¾ç¤ºæµ®åŠ¨æ¢å¤æŒ‰é’®
            function showRestoreBtn(){
                if($('#collectRestoreBtn').length) {
                    $('#collectRestoreBtn').fadeIn(300);
                    return;
                }
                var btn = $('<div id="collectRestoreBtn" style="' +
                    'position:fixed;right:20px;bottom:30px;z-index:19999;' +
                    'background:linear-gradient(135deg,#1890ff,#36cfc9);color:#fff;' +
                    'padding:12px 20px;border-radius:30px;cursor:pointer;' +
                    'box-shadow:0 4px 15px rgba(24,144,255,0.4);font-size:14px;' +
                    'display:flex;align-items:center;gap:8px;' +
                    'animation:collectPulse 2s infinite;' +
                    'transition:transform 0.2s,box-shadow 0.2s;' +
                    '">' +
                    '<i class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop" style="font-size:18px;"></i>' +
                    '<span>é‡‡é›†è¿›è¡Œä¸­ - ç‚¹å‡»æŸ¥çœ‹</span>' +
                    '</div>');
                btn.hover(
                    function(){ $(this).css({transform:'scale(1.05)', boxShadow:'0 6px 20px rgba(24,144,255,0.5)'}); },
                    function(){ $(this).css({transform:'scale(1)', boxShadow:'0 4px 15px rgba(24,144,255,0.4)'}); }
                );
                btn.click(function(){ reopenProgressPanel(); });
                $('body').append(btn);
                // æ·»åŠ è„‰å†²åŠ¨ç”»æ ·å¼
                if(!$('#collectPulseStyle').length){
                    $('head').append('<style id="collectPulseStyle">@keyframes collectPulse{0%,100%{box-shadow:0 4px 15px rgba(24,144,255,0.4)}50%{box-shadow:0 4px 25px rgba(24,144,255,0.7)}}</style>');
                }
            }

            function hideRestoreBtn(){
                $('#collectRestoreBtn').fadeOut(300, function(){ $(this).remove(); });
            }

            // æ›´æ–°æµ®åŠ¨æŒ‰é’®æ–‡å­—ï¼ˆå®Œæˆåï¼‰
            function updateRestoreBtnDone(){
                var btn = $('#collectRestoreBtn');
                if(btn.length){
                    btn.find('i').removeClass('layui-anim-rotate layui-anim-loop').css('animation','none');
                    btn.find('span').text('é‡‡é›†å·²å®Œæˆ - ç‚¹å‡»æŸ¥çœ‹ç»“æœ');
                    btn.css({background:'linear-gradient(135deg,#52c41a,#73d13d)', animation:'none'});
                }
            }

            // æ„å»ºè¿›åº¦é¢æ¿HTML
            function buildProgressHTML(){
                var html = '<div id="collectProgress" style="padding:15px;height:100%;display:flex;flex-direction:column;">';
                html += '<div style="display:flex;gap:15px;margin-bottom:10px;font-size:14px;">';
                html += '<span>âœ… æˆåŠŸ: <b id="sseSuccess">' + window._collectStats.success + '</b></span>';
                html += '<span>âŒ å¤±è´¥: <b id="sseFail">' + window._collectStats.fail + '</b></span>';
                html += '<span>â­ï¸ è·³è¿‡: <b id="sseSkip">' + window._collectStats.skip + '</b></span>';
                var statusText = window._collectDone ? 'å·²å®Œæˆ' : (window._collectSSE ? 'é‡‡é›†ä¸­...' : 'è¿æ¥æ–­å¼€');
                var statusColor = window._collectDone ? '#4CAF50' : (window._collectSSE ? '#4CAF50' : '#E57373');
                html += '<span id="sseStatus" style="color:' + statusColor + ';margin-left:auto;">' + statusText + '</span>';
                html += '</div>';
                html += '<div id="sseLog" style="flex:1;overflow-y:auto;background:#1e1e1e;color:#d4d4d4;padding:12px;border-radius:6px;font-family:Consolas,monospace;font-size:13px;line-height:1.8;"></div>';
                html += '</div>';
                return html;
            }

            // å‘æ—¥å¿—åŒºåŸŸè¿½åŠ ä¸€è¡Œ
            function appendLogToEl(logEl, msg, color){
                var line = document.createElement('div');
                line.style.color = color || '#d4d4d4';
                line.textContent = msg;
                logEl.appendChild(line);
                logEl.scrollTop = logEl.scrollHeight;
            }

            // è¿½åŠ æ—¥å¿—ï¼ˆä¿å­˜ + å†™å…¥DOMï¼‰
            function appendLog(msg, color){
                window._collectLogs.push({msg: msg, color: color});
                var logEl = document.getElementById('sseLog');
                if(logEl){
                    appendLogToEl(logEl, msg, color);
                }
            }

            // æ›´æ–°ç»Ÿè®¡
            function updateStats(d){
                if(d.success !== undefined) window._collectStats.success = d.success;
                if(d.fail !== undefined) window._collectStats.fail = d.fail;
                if(d.skip !== undefined) window._collectStats.skip = d.skip;
                // æ›´æ–°DOM
                var el;
                el = document.getElementById('sseSuccess');
                if(el) el.textContent = window._collectStats.success;
                el = document.getElementById('sseFail');
                if(el) el.textContent = window._collectStats.fail;
                el = document.getElementById('sseSkip');
                if(el) el.textContent = window._collectStats.skip;
            }

            // é‡æ–°æ‰“å¼€è¿›åº¦é¢æ¿
            function reopenProgressPanel(){
                hideRestoreBtn();
                window._collectPanelIndex = layer.open({
                    type: 1,
                    title: 'é‡‡é›†è¿›åº¦ - ' + window._collectTitle,
                    area: ['700px', '500px'],
                    content: buildProgressHTML(),
                    shade: 0.3,
                    closeBtn: 1,
                    cancel: function(){
                        window._collectPanelIndex = null;
                        if(window._collectSSE && !window._collectDone){
                            showRestoreBtn();
                        }
                    }
                });
                // é‡æ”¾æ‰€æœ‰æ—¥å¿—
                var logEl = document.getElementById('sseLog');
                if(logEl){
                    window._collectLogs.forEach(function(log){
                        appendLogToEl(logEl, log.msg, log.color);
                    });
                    logEl.scrollTop = logEl.scrollHeight;
                }
            }

            // å¼€å§‹SSEé‡‡é›†
            function startCollect(nodeData, pages){
                // é‡ç½®çŠ¶æ€
                window._collectLogs = [];
                window._collectStats = {success:0, fail:0, skip:0};
                window._collectTitle = nodeData.name;
                window._collectDone = false;
                hideRestoreBtn();

                var sseUrl = '{:url("collect/executeStream")}' + '?id=' + nodeData.id + '&pages=' + pages;

                // æ‰“å¼€è¿›åº¦é¢æ¿
                window._collectPanelIndex = layer.open({
                    type: 1,
                    title: 'é‡‡é›†è¿›åº¦ - ' + nodeData.name,
                    area: ['700px', '500px'],
                    content: buildProgressHTML(),
                    shade: 0.3,
                    closeBtn: 1,
                    cancel: function(){
                        window._collectPanelIndex = null;
                        if(window._collectSSE && !window._collectDone){
                            // ä¸å…³é—­SSEï¼Œæ˜¾ç¤ºæµ®åŠ¨æŒ‰é’®
                            showRestoreBtn();
                        }
                    }
                });

                // å¯åŠ¨ SSE
                var es = new EventSource(sseUrl);
                window._collectSSE = es;

                es.addEventListener('start', function(e){
                    var d = JSON.parse(e.data);
                    var statusEl = document.getElementById('sseStatus');
                    if(statusEl){ statusEl.textContent = 'é‡‡é›†ä¸­...'; statusEl.style.color = '#4CAF50'; }
                    appendLog('â–¶ ' + d.msg, '#4CAF50');
                });
                es.addEventListener('page', function(e){
                    var d = JSON.parse(e.data);
                    appendLog('ğŸ“„ ' + d.msg, '#64B5F6');
                });
                es.addEventListener('page_links', function(e){
                    var d = JSON.parse(e.data);
                    appendLog('ğŸ”— ' + d.msg, '#90CAF9');
                });
                es.addEventListener('fetching', function(e){
                    var d = JSON.parse(e.data);
                    var statusEl = document.getElementById('sseStatus');
                    if(statusEl) statusEl.textContent = d.msg;
                    appendLog('  â³ ' + d.msg, '#B0BEC5');
                });
                es.addEventListener('success', function(e){
                    var d = JSON.parse(e.data);
                    updateStats(d);
                    appendLog('  âœ… ' + d.msg, '#81C784');
                });
                es.addEventListener('fail', function(e){
                    var d = JSON.parse(e.data);
                    updateStats(d);
                    appendLog('  âŒ ' + d.msg, '#E57373');
                });
                es.addEventListener('skip', function(e){
                    var d = JSON.parse(e.data);
                    updateStats(d);
                    appendLog('  â­ï¸ ' + d.msg, '#FFB74D');
                });
                es.addEventListener('warning', function(e){
                    var d = JSON.parse(e.data);
                    appendLog('  âš ï¸ ' + d.msg, '#FF7043');
                });
                es.addEventListener('info', function(e){
                    var d = JSON.parse(e.data);
                    appendLog('  ğŸ“¥ ' + d.msg, '#26C6DA');
                });
                es.addEventListener('error', function(e){
                    if(e.data){
                        var d = JSON.parse(e.data);
                        appendLog('âš ï¸ ' + d.msg, '#FF8A65');
                    }
                });
                es.addEventListener('done', function(e){
                    var d = JSON.parse(e.data);
                    updateStats(d);
                    window._collectDone = true;
                    var statusEl = document.getElementById('sseStatus');
                    if(statusEl){ statusEl.textContent = 'å·²å®Œæˆ'; statusEl.style.color = '#4CAF50'; }
                    appendLog('', '#fff');
                    appendLog('ğŸ‰ ' + d.msg, '#FFD54F');
                    es.close();
                    window._collectSSE = null;
                    // å¦‚æœé¢æ¿å·²å…³é—­ï¼Œæ›´æ–°æµ®åŠ¨æŒ‰é’®
                    if(!window._collectPanelIndex){
                        updateRestoreBtnDone();
                    }
                });
                es.onerror = function(){
                    window._collectDone = true;
                    var statusEl = document.getElementById('sseStatus');
                    if(statusEl){ statusEl.textContent = 'è¿æ¥æ–­å¼€'; statusEl.style.color = '#E57373'; }
                    appendLog('âš ï¸ è¿æ¥å·²æ–­å¼€ï¼ˆæœåŠ¡ç«¯ä»åœ¨åå°é‡‡é›†ï¼Œæ•°æ®ä¼šå†™å…¥è‰ç¨¿ç®±ï¼‰', '#E57373');
                    es.close();
                    window._collectSSE = null;
                    if(!window._collectPanelIndex){
                        updateRestoreBtnDone();
                    }
                };
            }

            // æ¸²æŸ“è¡¨æ ¼
            table.render({
                elem: '#nodeTable',
                url: '{:url("collect/index")}',
                page: true,
                cols: [[
                    {field: 'id', title: 'ID', width: 60, align: 'center'},
                    {field: 'name', title: 'èŠ‚ç‚¹åç§°'},
                    {field: 'url', title: 'é‡‡é›†åœ°å€(å«åˆ†é¡µ)'},
                    {field: 'category_id', title: 'å…¥åº“åˆ†ç±»', templet: function(d){
                        return d.category ? d.category.name : 'æœªçŸ¥åˆ†ç±»';
                    }},
                    {field: 'charset', title: 'ç¼–ç ', width: 80, align: 'center'},
                    {title: 'æ“ä½œ', width: 280, toolbar: '#barDemo', align: 'center'}
                ]]
            });

            // æ·»åŠ èŠ‚ç‚¹
            $('#addNode').click(function(){
                layer.open({
                    type: 2,
                    title: 'æ·»åŠ èŠ‚ç‚¹',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['800px', '90%'],
                    content: '{:url("collect/form")}',
                    end: function(){
                        table.reload('nodeTable');
                    }
                });
            });

            // å·¥å…·æ¡äº‹ä»¶
            table.on('tool(nodeTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'del'){
                    layer.confirm('ç¡®è®¤åˆ é™¤è¯¥èŠ‚ç‚¹å—ï¼Ÿ', function(index){
                        $.post('{:url("collect/delete")}', {id: data.id}, function(res){
                            if(res.code == 1){
                                layer.msg(res.msg, {icon: 1, time: 1000}, function(){
                                    obj.del();
                                });
                            }else{
                                layer.msg(res.msg, {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                } else if(obj.event === 'edit'){
                    layer.open({
                        type: 2,
                        title: 'ç¼–è¾‘èŠ‚ç‚¹',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['800px', '90%'],
                        content: '{:url("collect/form")}?id=' + data.id,
                        end: function(){
                            table.reload('nodeTable');
                        }
                    });
                } else if(obj.event === 'test'){
                    layer.prompt({
                        title: 'è¾“å…¥æµ‹è¯•åˆ—è¡¨åœ°å€(æµ‹è¯•ç¬¬ä¸€ä¸ªé¡µé¢çš„åˆ—è¡¨æŠ“å–)',
                        value: data.url.replace('[page]', '1')
                    }, function(value, index, elem){
                        layer.close(index);
                        var loadIndex = layer.msg('æ­£åœ¨æŠ“å–è¿œç¨‹é¡µé¢ï¼Œè¯·è€å¿ƒç­‰å¾…...', {icon: 16, shade: 0.3, time: 0});
                        $.ajax({
                            url: '{:url("collect/testList")}',
                            type: 'POST',
                            data: {id: data.id, url: value},
                            dataType: 'json',
                            timeout: 30000,
                            success: function(res){
                                layer.close(loadIndex);
                                if(res.code == 1){
                                    let links = res.data.map(item => item.link).join('<br>');
                                    layer.open({
                                      type: 1,
                                      title: 'æµ‹è¯•åˆ—è¡¨æŠ“å–æˆåŠŸ (å…±' + res.data.length + 'æ¡é“¾æ¥)',
                                      area: ['600px', '400px'],
                                      content: '<div style="padding: 20px;">' + links + '</div>'
                                    });
                                }else{
                                    layer.alert(res.msg, {title: 'å¤±è´¥', icon: 2});
                                }
                            },
                            error: function(xhr, status, error){
                                layer.close(loadIndex);
                                if(status === 'timeout'){
                                    layer.alert('è¯·æ±‚è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œç›®æ ‡ç½‘ç«™å“åº”å¤ªæ…¢', {title: 'è¶…æ—¶', icon: 2});
                                }else{
                                    layer.alert('è¯·æ±‚å¤±è´¥ï¼š' + (error || 'ç½‘ç»œé”™è¯¯'), {title: 'é”™è¯¯', icon: 2});
                                }
                            }
                        });
                    });
                } else if(obj.event === 'execute'){
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„é‡‡é›†
                    if(window._collectSSE){
                        layer.confirm('å½“å‰æœ‰é‡‡é›†ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œæ˜¯å¦æŸ¥çœ‹è¿›åº¦ï¼Ÿ', {
                            btn: ['æŸ¥çœ‹è¿›åº¦', 'å–æ¶ˆ']
                        }, function(index){
                            layer.close(index);
                            reopenProgressPanel();
                        });
                        return;
                    }
                    layer.prompt({
                        title: 'è¦é‡‡é›†å¤šå°‘é¡µæ•°æ®ï¼Ÿ',
                        formType: 0,
                        value: '1'
                    }, function(value, index){
                        layer.close(index);
                        startCollect(data, value);
                    });
                }
            });
        });
    </script>
</body>
</html>
