<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>文章编辑</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <link rel="stylesheet" href="/static/css/admin-article.css">
    <!-- Highlight.js via CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    
    <!-- wangEditor -->
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
    <script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
</head>
<body>
    <div class="container">
        <div class="layui-breadcrumb" style="margin-bottom: 20px;">
            <a href="{:url('article/index')}">文章管理</a>
            <a><cite>{$info ? '编辑文章' : '发布文章'}</cite></a>
        </div>

        <form class="layui-form" action="">
            <input type="hidden" name="id" value="{$info.id|default='0'}">
            
            <div class="layui-form-item">
                <label class="layui-form-label">标题</label>
                <div class="layui-input-block">
                    <input type="text" name="title" value="{$info.title|default=''}" lay-verify="required" placeholder="请输入文章标题" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">所属分类</label>
                <div class="layui-input-block">
                    <select name="category_id" lay-verify="required">
                        <option value="">请选择分类</option>
                        {volist name="categories" id="vo"}
                        <option value="{$vo.id}" {if condition="$info && $info.category_id == $vo.id"}selected{/if}>{$vo.name}</option>
                        {/volist}
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">文章描述</label>
                <div class="layui-input-block">
                    <textarea name="description" placeholder="请输入简介" class="layui-textarea">{$info.description|default=''}</textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">文章内容</label>
                <div class="layui-input-block">
                    <!-- Custom Editor -->
                    <!-- wangEditor implementation -->
                    <div id="wangeditor-container" style="border: 1px solid #ccc;">
                        <div id="wangeditor-toolbar" style="border-bottom: 1px solid #ccc;"></div>
                        <div id="wangeditor-text" style="height: 500px;"></div>
                    </div>
                    
                    <!-- Hidden inputs for submission -->
                    <textarea name="content" id="content-hidden" style="display: none;"></textarea>
                    <input type="file" id="img-upload" style="display: none;" accept="image/*">
                    <input type="file" id="video-upload" style="display: none;" accept="video/*">
                </div>
            </div>

            <div class="layui-row">
                <div class="layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">销售价格</label>
                        <div class="layui-input-block">
                            <input type="text" name="price" value="{$info.price|default='0.00'}" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">VIP优惠</label>
                        <div class="layui-input-block">
                            <select name="is_vip_free">
                                <option value="0" {if condition="$info && $info.is_vip_free == 0"}selected{/if}>不免费</option>
                                <option value="1" {if condition="$info && $info.is_vip_free == 1"}selected{/if}>VIP免费</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">资源链接</label>
                <div class="layui-input-block">
                    <input type="text" name="resource_url" value="{$info.resource_url|default=''}" placeholder="下载链接" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">提取码</label>
                <div class="layui-input-block">
                    <input type="text" name="resource_pwd" value="{$info.resource_pwd|default=''}" placeholder="资源提取码" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item" style="margin-top: 40px;">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="save">保存并发布</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>

    <script src="/static/layui/layui.js"></script>
    <!-- Marked & Turndown for Markdown Support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <script>
        layui.use(['form', 'layer', 'jquery'], function(){
            var form = layui.form;
            var layer = layui.layer;
            var $ = layui.jquery;

            // wangEditor Initialization
            const { createEditor, createToolbar } = window.wangEditor;

            const editorConfig = {
                placeholder: '请输入文章内容...',
                MENU_CONF: {
                    uploadImage: {
                        server: "{:url('upload/image')}",
                        fieldName: 'file',
                        maxFileSize: 5 * 1024 * 1024
                    },
                    uploadVideo: {
                        server: "{:url('upload/video')}",
                        fieldName: 'file',
                        maxFileSize: 100 * 1024 * 1024
                    }
                },
                onChange(editor) {
                    const html = editor.getHtml();
                    $('#content-hidden').val(html);
                }
            };

            const editor = createEditor({
                selector: '#wangeditor-text',
                html: '{$info.content|raw|default=""}',
                config: editorConfig,
                mode: 'default'
            });

            const toolbarConfig = {};
            const toolbar = createToolbar({
                editor: editor,
                selector: '#wangeditor-toolbar',
                config: toolbarConfig,
                mode: 'default'
            });

            // Initial sync
            $('#content-hidden').val(editor.getHtml());

            // Highlight Code on Load
            if(window.hljs) hljs.highlightAll();

            // Submit
            form.on('submit(save)', function(data){
                // Ensure content is synced
                var content = editor.getHtml();
                data.field.content = content;
                
                if (!content || content === '<p><br></p>') {
                    layer.msg('文章内容不能为空', {icon: 2});
                    return false;
                }

                $.post("{:url('article/save')}", data.field, function(res){
                    if(res.code === 1){
                        layer.msg(res.msg, {icon: 1, time: 1000}, function(){
                            location.href = "{:url('article/index')}";
                        });
                    }else{
                        layer.msg(res.msg, {icon: 2});
                    }
                }, 'json');
                return false;
            });
        });
    </script>
</body>
</html>
