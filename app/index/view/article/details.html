{include file="layout/header" /}
<link rel="stylesheet" href="/static/css/article-premium.css?v=1.5">
<link rel="stylesheet" href="/static/css/article_details.css">

<div class="container article-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb-box">
        <span class="layui-breadcrumb" lay-separator=">">
            <a href="/">é¦–é¡µ</a>
            <a href="/?cat={$article.category_id}.html">{$article.category.name}</a>
            <a><cite>æ­£æ–‡</cite></a>
        </span>
    </div>

    <div class="layui-row layui-col-space30">
        <!-- Main Content -->
        <div class="layui-col-md9">
            
            <!-- Title & Meta (V5 Style) -->
            <div class="article-header-v5">
                <h1 class="article-title-v5">{$article.title}</h1>
                <div class="article-meta-v5">
                    <div class="meta-item"><i class="layui-icon layui-icon-time"></i> {$article.create_time|date='Y-m-d'}</div>
                    <div class="meta-item"><i class="layui-icon layui-icon-app"></i> {$article.category.name}</div>
                    <div class="meta-item"><i class="layui-icon layui-icon-fire"></i> {$article.views}</div>
                    <div class="meta-item"><i class="layui-icon layui-icon-dialogue"></i> {$comments->total()}</div>
                </div>
            </div>

            <!-- Tabs (V5 Style) -->
            <div class="tabs-v5">
                <div class="tab-btn-v5 active" onclick="switchTab(this, 'detail')">
                    <i class="layui-icon layui-icon-file-text"></i> <span class="hidden-xs">è¯¦æƒ…ä»‹ç»</span>
                </div>
                <div class="tab-btn-v5" onclick="switchTab(this, 'faq')">
                    <i class="layui-icon layui-icon-question"></i> <span class="hidden-xs">å¸¸è§é—®é¢˜</span>
                </div>
                <div class="tab-btn-v5" onclick="switchTab(this, 'comments')" id="tab-comments">
                    <i class="layui-icon layui-icon-dialogue"></i> <span class="hidden-xs">è¯„è®ºå»ºè®®</span>
                </div>
            </div>

            <!-- Content: Detail -->
            <div id="content-detail" class="tab-content-block">
                
                <!-- Video/Media (Removed Title Overlay) -->
                <!-- Video/Media (Removed Title Overlay) -->
                {if condition="isset($article.video_url) AND !empty($article.video_url)"}
                <div class="article-media-box" style="margin-bottom: 20px;">
                    <video src="{$article.video_url}" controls style="width:100%; height:100%; object-fit:contain;"></video>
                </div>
                {/if}

                <!-- Position 2 Ads (Above Content) -->
                {if condition="(!isset($config.ad_global_status) || $config.ad_global_status == 1) && (!isset($config.ad_pos_2_status) || $config.ad_pos_2_status == 1) && (!isset($config.ad_vip_exempt) || $config.ad_vip_exempt == 0 || !isset($user.vip_level) || $user.vip_level == 0)"}
                {volist name="ads_pos2" id="ad"}
                <div class="ad-container" style="margin-bottom: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    {if $ad.type == 1}
                    <a href="{$ad.link_url}" target="_blank"><img src="{$ad.image_url}" alt="{$ad.title}" style="width: 100%; display: block;"></a>
                    {else}{$ad.js_code|raw}{/if}
                </div>
                {/volist}
                {/if}

                <!-- Detail Box -->
                <div class="content-box">
                     <div class="intro-quote">
                          <i class="layui-icon layui-icon-quote-left" style="font-size:20px; color:#ccc; position:absolute; top:10px; left:10px;"></i>
                          <p>{$article.description|default=$article.title . ' - æœ¬ç«™ä¼˜è´¨èµ„æºï¼Œæ¬¢è¿ä¸‹è½½ä½“éªŒã€‚'}</p>
                     </div>
                     <div class="article-content" style="font-size:16px; line-height:1.8; color:#444;">
                         {if condition="$can_view"}
                             {$article.content|raw}
                         {/if}
                     </div>
                     
                     <!-- Position 4 Ads (Within Content) -->
                     {if condition="(!isset($config.ad_global_status) || $config.ad_global_status == 1) && (!isset($config.ad_pos_4_status) || $config.ad_pos_4_status == 1) && (!isset($config.ad_vip_exempt) || $config.ad_vip_exempt == 0 || !isset($user.vip_level) || $user.vip_level == 0)"}
                     {volist name="ads_pos4" id="ad"}
                     <div class="ad-container" style="margin: 20px 0; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                          {if $ad.type == 1}
                          <a href="{$ad.link_url}" target="_blank"><img src="{$ad.image_url}" alt="{$ad.title}" style="width: 100%; display: block;"></a>
                          {else}{$ad.js_code|raw}{/if}
                     </div>
                     {/volist}
                     {/if}

                     <div class="locked-content-box">
                          {if condition="!$can_view"}
                              <i class="layui-icon layui-icon-password lock-icon"></i>
                              <h3 style="font-size:18px; font-weight:700; color:#ff4444; margin-bottom:10px;">
                                  <i class="layui-icon layui-icon-locked"></i> æœ¬å†…å®¹éœ€æƒé™æŸ¥çœ‹
                              </h3>
                              <div style="margin-bottom:25px; color:#666;">
                                  {if condition="$article.price > 0"}
                                     éœ€è¦æ”¯ä»˜ <span style="color:#ff4444; font-weight:700;">{$article.price}å…ƒ</span> æˆ– <span style="color:#dda346; font-weight:700;">VIPä¼šå‘˜</span> å…è´¹æŸ¥çœ‹
                                  {else /}
                                      æœ¬èµ„æºä¸ºå…è´¹èµ„æºï¼Œè¯·ç™»å½•åæŸ¥çœ‹
                                  {/if}
                              </div>
                              <button class="buy-access-btn" onclick="buy()"><i class="layui-icon layui-icon-cart"></i> è´­ä¹°ç«‹å³æŸ¥çœ‹</button>
                              <div style="margin-top:15px; font-size:12px; color:#999;">
                                  <a href="/user/index.html?tab=vip.html" target="_blank" style="color:#666; text-decoration:underline;">å¼€é€šVIPä¼šå‘˜å…è´¹ä¸‹è½½æ‰€æœ‰èµ„æº ></a>
                              </div>
                          {else /}
                              <div style="background:#f0f9eb; color:#67c23a; padding:15px; border-radius:8px; display:inline-block; border:1px solid #e1f3d8;">
                                  <i class="layui-icon layui-icon-ok-circle"></i> æ‚¨å·²æ‹¥æœ‰æŸ¥çœ‹æƒé™
                                  <div style="margin-top:10px;">
                                      ä¸‹è½½åœ°å€ï¼š<a href="{:url('article/download', ['id'=>$article.id])}" target="_blank" style="color:#409eff; text-decoration:underline;">ç‚¹å‡»ä¸‹è½½</a>
                                      <br>æå–ç ï¼š{$article.resource_pwd|default='æ— '}
                                  </div>
                              </div>
                          {/if}
                     </div>
                                                               
                     <!-- Action Bar -->
                     <div class="action-bar-v5">
                        <div class="author-info-v5">
                            {if isset($article.user) && !empty($article.user)}
                                {if !empty($article.user.avatar)}
                                    <img src="{$article.user.avatar}" class="author-avatar-v5">
                                {else /}
                                    <div class="author-avatar-v5 icon-avatar" style="background: #f1f2f5; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #999;">
                                        <i class="layui-icon layui-icon-username"></i>
                                    </div>
                                {/if}
                                <div>
                                    <div style="font-weight:700; font-size:14px;">{$article.user.nickname|default=$article.user.username|default='ç®¡ç†å‘˜'}</div>
                                </div>
                            {else /}
                                <div class="author-avatar-v5 icon-avatar" style="background: #f1f2f5; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #999;">
                                    <i class="layui-icon layui-icon-username"></i>
                                </div>
                                <div>
                                    <div style="font-weight:700; font-size:14px;">ç®¡ç†å‘˜</div>
                                </div>
                            {/if}
                        </div>
                        <div class="action-buttons-v5">
                            <div class="action-btn btn-share" onclick="shareArticle()"><i class="layui-icon layui-icon-share"></i> åˆ†äº«</div>
                            <div class="action-btn btn-collect {if $is_collected}active{/if}" onclick="collectArticle(this)" data-id="{$article.id}">
                                <i class="layui-icon {if $is_collected}layui-icon-star-fill{else}layui-icon-star{/if}"></i> 
                                <span>{if $is_collected}å·²æ”¶è—{else}æ”¶è—{/if}</span>
                            </div>
                            <div class="action-btn btn-like {if $is_liked}active{/if}" onclick="likeArticle(this)" data-id="{$article.id}">
                                <i class="layui-icon {if $is_liked}layui-icon-praise{else}layui-icon-praise{/if}"></i> 
                                <span>ç‚¹èµ({$like_count})</span>
                            </div>
                        </div>
                     </div>

                     <!-- Position 4 Ads -->
                     {if condition="(!isset($config.ad_global_status) || $config.ad_global_status == 1) && (!isset($config.ad_pos_4_status) || $config.ad_pos_4_status == 1) && (!isset($config.ad_vip_exempt) || $config.ad_vip_exempt == 0 || !isset($user.vip_level) || $user.vip_level == 0)"}
                     {volist name="ads_pos4" id="ad"}
                     <div class="ad-container" style="margin-top: 20px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                          {if $ad.type == 1}
                          <a href="{$ad.link_url}" target="_blank"><img src="{$ad.image_url}" alt="{$ad.title}" style="width: 100%; display: block;"></a>
                          {else}{$ad.js_code|raw}{/if}
                     </div>
                     {/volist}
                     {/if}
                </div>
            </div>
            
            <!-- Prev/Next Navigation (Redesigned) -->
            <div class="nav-prev-next">
                {if $prev_article}
                <a href="/article/details.html?id={$prev_article.id}.html" class="nav-item nav-prev">
                    <span class="nav-arrow"><i class="layui-icon layui-icon-left"></i></span>
                    <div class="nav-text-container">
                        <div class="nav-label" style="align-items: flex-end; text-align: right;">ä¸Šä¸€ç¯‡</div>
                        <div class="nav-title">{$prev_article.title}</div>
                    </div>
                </a>
                {else /}
                <div class="nav-item nav-prev disabled">
                    <div class="nav-text-container">
                        <div class="nav-label" style="align-items: flex-end; text-align: right;">ä¸Šä¸€ç¯‡</div>
                        <div class="nav-title" style="align-items: flex-end; text-align: right;">æ²¡æœ‰äº†</div>
                    </div>
                </div>
                {/if}
                
                {if $next_article}
                <a href="/article/details.html?id={$next_article.id}.html" class="nav-item nav-next">
                    <div class="nav-text-container">
                        <div class="nav-label">ä¸‹ä¸€ç¯‡</div>
                        <div class="nav-title">{$next_article.title}</div>
                    </div>
                    <span class="nav-arrow"><i class="layui-icon layui-icon-right"></i></span>
                </a>
                {else /}
                <div class="nav-item nav-next disabled">
                    <div class="nav-text-container">
                        <div class="nav-label">ä¸‹ä¸€ç¯‡</div>
                        <div class="nav-title">æ²¡æœ‰äº†</div>
                    </div>
                </div>
                {/if}
            </div>
            
            <!-- FAQ (Hidden Default) -->
            <div id="content-faq" class="tab-content-block" style="display:none;">
                <div class="content-box">
                    <div class="section-title">å¸¸è§é—®é¢˜</div>
                    <div style="line-height:2; padding: 20px;">
                        <p><strong>Q: è´­ä¹°åå¦‚ä½•ä¸‹è½½ï¼Ÿ</strong><br>A: æ”¯ä»˜æˆåŠŸåé¡µé¢è‡ªåŠ¨åˆ·æ–°ï¼Œç‚¹å‡»â€œç«‹å³ä¸‹è½½â€å³å¯ã€‚</p>
                        <p><strong>Q: èµ„æºé“¾æ¥å¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ</strong><br>A: è¯·è”ç³»å®¢æœæˆ–åœ¨è¯„è®ºåŒºç•™è¨€åé¦ˆï¼Œæˆ‘ä»¬å°†å°½å¿«ä¿®å¤ã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- Comments (Hidden Default) -->
            <div id="content-comments" class="tab-content-block" style="display:none;">
                <div class="content-box" style="padding: 30px;">
                     <!-- Keep existing comment code -->
                     <div class="comment-section-header"><i class="layui-icon layui-icon-dialogue"></i> è¯„è®º({$comments->total()})</div>
                     <div class="comment-input-box">
                        <textarea id="comment_content" class="comment-textarea" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹..."></textarea>
                        <div class="comment-actions">
                            <div style="color:#f56c6c; background:#fef0f0; padding:2px 8px; font-size:12px; border-radius:2px;">æç¤ºï¼šè¯·æ–‡æ˜å‘è¨€</div>
                            <button class="submit-btn" onclick="submitComment()">æäº¤è¯„è®º</button>
                        </div>
                    </div>
                    <div class="comment-list">
                        {volist name="comments" id="vo" empty="<div style='text-align:center;color:#999;padding:20px;'>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</div>"}
                        <div class="comment-item">
                            <div class="c-avatar"><div class="comment-user-icon"><i class="layui-icon layui-icon-username"></i></div></div>
                            <div class="c-content">
                                <div class="c-user-info">
                                    <span class="c-username">{$vo.user.username|default='åŒ¿åç”¨æˆ·'}</span>
                                    {if condition="isset($vo.user.vip_level) AND $vo.user.vip_level > 0"}
                                    <span class="c-badge-vip">VIP</span>
                                    {/if}
                                    <span class="c-badge-user"><i class="layui-icon layui-icon-diamond" style="font-size:10px;"></i> æ™®é€šç”¨æˆ·</span>
                                </div>
                                <div class="c-text">{$vo.content}</div>
                                <div class="c-meta"><span>{$vo.create_time|date='Y-m-d H:i:s'}</span><a href="javascript:;" style="color:#666;">å›å¤</a></div>
                            </div>
                        </div>
                        {/volist}
                    </div>
                    <div class="pagination-box">{$comments|raw}</div>
                </div>
            </div>

            <!-- Related Articles -->
            <div class="content-box" style="margin-top: 30px;">
                <div class="section-title"><i class="layui-icon layui-icon-link"></i> ç›¸å…³æ¨è</div>
                <div class="related-grid-v5">
                     {volist name="related_articles" id="vo" empty=""}
                     <div class="related-card-v5">
                         <a href="/article/details.html?id={$vo.id}.html">
                             <img src="{$vo.cover_url|default=$config.article_default_image|default='/static/images/default.jpg'}" class="related-thumb" alt="{$vo.title}">
                         </a>
                         <div class="related-info">
                             <div class="related-title">
                                 <a href="/article/details.html?id={$vo.id}.html" style="color:#333;">{$vo.title}</a>
                             </div>
                             <div style="font-size:12px; color:#999;">
                                 <i class="layui-icon layui-icon-time"></i> {$vo.create_time|date='Y-m-d'}
                             </div>
                         </div>
                     </div>
                     {/volist}
                </div>
            </div>

        </div>

        <!-- Sidebar -->
        <div class="layui-col-md3">
            <!-- Author Widget -->
            <div class="premium-card author-widget">
                 <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                     {if isset($article.user) && !empty($article.user)}
                         {if !empty($article.user.avatar)}
                            <img src="{$article.user.avatar}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                         {else /}
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #999;">
                                <i class="layui-icon layui-icon-username"></i>
                            </div>
                         {/if}
                         <div style="text-align:left;">
                             <div class="author-name">{$article.user.nickname|default=$article.user.username|default='ç®¡ç†å‘˜'}</div>
                             <span class="author-badge" style="background:#f0f9eb; color:#67c23a; border-color:#e1f3d8;">ğŸŒŸ ä¼˜è´¨åˆ›ä½œè€…</span>
                         </div>
                     {else /}
                         <div style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #666;">
                             <i class="layui-icon layui-icon-username"></i>
                         </div>
                         <div style="text-align:left;">
                             <div class="author-name">ç®¡ç†å‘˜</div>
                             <span class="author-badge">ğŸ‘‘ å®˜æ–¹å›¢é˜Ÿ</span>
                         </div>
                     {/if}
                 </div>
                <div class="author-stats">
                    <div class="stat-item"><span class="stat-num">{$author_articles_count}</span><span class="stat-label">æ–‡ç« </span></div>
                    <div class="stat-item"><span class="stat-num">{$author_comments_count}</span><span class="stat-label">è¯„è®º</span></div>
                    <div class="stat-item"><span class="stat-num">{$author_fans_count}</span><span class="stat-label">ç²‰ä¸</span></div>
                </div>
                <div style="margin-top:20px;">
                    <a href="#" style="font-size:12px; color:#999;">æŸ¥çœ‹ä½œè€…å…¶ä»–æ–‡ç«  ></a>
                </div>
            </div>

            <!-- Purchase Widget -->
            <div class="purchase-widget premium-card">
                <div class="price-header"><i class="layui-icon layui-icon-diamond"></i> èµ„æºå”®ä»·</div>
                <div class="price-tag-wrap">
                    <div class="price-item" style="border-right:1px solid #e6d3b3;">
                        <div class="vip-free-badge">VIPä¼šå‘˜</div>
                        <div style="color: #d4a356; font-weight:700;">{if condition="$article.price > 0"}æŠ˜æ‰£/å…{else /}å…è´¹{/if}</div>
                    </div>
                     <div class="price-item">
                        <div class="vip-free-badge">ä»·æ ¼</div>
                        <div class="price-val-lg">{$article.price}<span style="font-size:12px;">å…ƒ</span></div>
                    </div>
                </div>
                <div class="buy-actions">
                    {if condition="$can_view"}
                         <button class="btn-block-danger" style="background:#00c851; cursor:default;">
                             <i class="layui-icon layui-icon-ok"></i> å·²è´­ä¹°/æ‹¥æœ‰æƒé™
                         </button>
                    {else /}
                        <button class="btn-block-danger" onclick="buy()">
                            <i class="layui-icon layui-icon-cart"></i> ç«‹å³è´­ä¹°æƒé™
                        </button>
                    {/if}
                    <div class="buy-info-text"><i class="layui-icon layui-icon-auz"></i> å·²æœ‰ {$article.sales|default=0} äººè´­ä¹°ä¸‹è½½</div>
                    <div class="buy-info-text">é‡åˆ°é—®é¢˜ï¼Ÿ<a href="#" style="text-decoration:underline;">è”ç³»å®¢æœåé¦ˆ</a></div>
                </div>
            </div>

            <!-- Ranking List -->
            <div class="premium-card" style="padding:20px;">
                <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; font-weight:700;">çƒ­é—¨æ’è¡Œæ¦œ</div>
                 {volist name="hot_articles" id="hot" key="k"}
                <div class="rank-list-item">
                    <span class="rank-num" {if condition="$k <= 3"}style="background:#ff4444; color:#fff;"{/if}>{$k}</span>
                    <a href="/article/details.html?id={$hot.id}.html" style="color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">{$hot.title}</a>
                </div>
                 {/volist}
            </div>

            <!-- Position 3 Ads (Sidebar Ranking Below) -->
            {if condition="(!isset($config.ad_global_status) || $config.ad_global_status == 1) && (!isset($config.ad_pos_3_status) || $config.ad_pos_3_status == 1) && (!isset($config.ad_vip_exempt) || $config.ad_vip_exempt == 0 || !isset($user.vip_level) || $user.vip_level == 0)"}
            {volist name="ads_pos3" id="ad"}
            <div class="ad-container" style="margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
                {if $ad.type == 1}
                <a href="{$ad.link_url}" target="_blank">
                    <img src="{$ad.image_url}" alt="{$ad.title}" style="width: 100%; display: block;">
                </a>
                {else}
                {$ad.js_code|raw}
                {/if}
            </div>
            {/volist}
            {/if}
        </div>
    </div>
</div>

<script>
    var isLogin = {if isset($user) && !empty($user)}true{else}false{/if};
    window.APP_CONFIG = window.APP_CONFIG || {};
    Object.assign(window.APP_CONFIG, {
        article_id: "{$article.id}",
        url_article_buy: "{:url('article/buy')}",
        url_pay_index: "{:url('index/pay/index')}",
        url_article_submitComment: "{:url('article/submitComment')}",
        url_article_share: "{:url('article/share')}",
        url_article_toggleFavorite: "{:url('article/toggleFavorite')}",
        url_article_like: "{:url('article/like')}"
    });
</script>
<script src="/static/js/article_details.js"></script>

{include file="layout/footer" /}
